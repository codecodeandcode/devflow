ä¸€ã€ä¸ºä»€ä¹ˆ User.create([ ... ], { session }) é‡Œé¢æ˜¯æ•°ç»„ï¼Ÿ

ä½ çœ‹åˆ°çš„æ˜¯ï¼š

[existingUser] = await User.create(
  [{ name, username: slugifiedUsername, email, image }],
  { session }
);

âœ… åŸå› ï¼šè¿™æ˜¯ Mongoose çš„â€œæ‰¹é‡åˆ›å»ºâ€è¯­æ³•

Model.create() æœ‰ä¸¤ç§ç”¨æ³•ï¼š

â‘  å•ä¸ªæ–‡æ¡£
const user = await User.create({
  name,
  email
});


è¿”å›çš„æ˜¯ä¸€ä¸ª documentã€‚

â‘¡ å¤šä¸ªæ–‡æ¡£ï¼ˆæ•°ç»„ï¼‰
const users = await User.create(
  [{ name, email }],
  { session }
);


è¿”å›çš„æ˜¯æ•°ç»„ï¼š

User[]

ğŸ’¡ é‚£ä¸ºä»€ä¹ˆè¿™é‡Œç”¨æ•°ç»„ï¼Ÿ

å› ä¸º åœ¨äº‹åŠ¡ï¼ˆtransactionï¼‰ä¸­ä½¿ç”¨ create æ—¶ï¼Œæ¨èä½¿ç”¨æ•°ç»„å½¢å¼ã€‚

Mongoose æ–‡æ¡£ä¸­è¯´æ˜ï¼š

åœ¨ transaction é‡Œï¼Œcreate() ä½¿ç”¨æ•°ç»„å½¢å¼å¯ä»¥ä¿è¯ session æ­£ç¡®ç»‘å®šã€‚

æ‰€ä»¥ï¼š

[{ ... }]


åªæ˜¯è¡¨ç¤ºï¼š

æˆ‘è¦åˆ›å»ºä¸€ä¸ª documentï¼Œä½†ä½¿ç”¨çš„æ˜¯â€œæ‰¹é‡åˆ›å»ºâ€å½¢å¼ã€‚

é‚£è¿™ä¸€è¡Œæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
[existingUser] = await User.create([...])


è¿™æ˜¯ æ•°ç»„è§£æ„èµ‹å€¼ã€‚

å› ä¸º create è¿”å›çš„æ˜¯ï¼š

User[]


æ‰€ä»¥ï¼š

[existingUser]


= æŠŠæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å–å‡ºæ¥èµ‹å€¼ç»™ existingUserã€‚

äºŒã€ä¸ºä»€ä¹ˆæœ‰çš„ç”¨ .session(session)ï¼Œæœ‰çš„ç”¨ { session }ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ ğŸ‘

å› ä¸º Mongoose æœ‰ä¸¤ç§ä¼  session çš„æ–¹å¼ã€‚

ğŸ”¹ ç¬¬ä¸€ç§ï¼šåœ¨ options é‡Œä¼ 

æ¯”å¦‚ï¼š

User.create([...], { session })


è¿™é‡Œ session æ˜¯ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ä¼ è¿›å»çš„ã€‚

ğŸ”¹ ç¬¬äºŒç§ï¼šé“¾å¼è°ƒç”¨

æ¯”å¦‚ï¼š

User.findOne({ email }).session(session)


è¿™å±äº Query APIã€‚

findOne() è¿”å›çš„æ˜¯ä¸€ä¸ª Query å¯¹è±¡ï¼š

Query


ç„¶åä½ å¯ä»¥é“¾å¼è°ƒç”¨ï¼š

.session(session)

ä¸ºä»€ä¹ˆ create ä¸èƒ½ç”¨ .session()ï¼Ÿ

å› ä¸ºï¼š

create()


ä¸æ˜¯ Queryï¼Œå®ƒæ˜¯ç›´æ¥æ‰§è¡Œçš„æ“ä½œã€‚

è€Œï¼š

findOne()
updateOne()


è¿”å›çš„æ˜¯ Queryï¼Œå¯ä»¥é“¾å¼è°ƒç”¨ã€‚

ç®€å•è®°å¿†æ³•ï¼š
æ–¹æ³•ç±»å‹	ä¼  session æ–¹å¼
Queryï¼ˆfind / update / deleteï¼‰	.session(session)
create	{ session } ä½œä¸ºå‚æ•°
ä¸‰ã€ä¸ºä»€ä¹ˆ _id è‡ªåŠ¨å­˜åœ¨ï¼Ÿ

ä½ é—®ï¼š

existingUser._id æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿ

è¿™æ˜¯ MongoDB è‡ªåŠ¨ç”Ÿæˆçš„ã€‚

åœ¨ MongoDB ä¸­ï¼š

æ¯ä¸€ä¸ª document é»˜è®¤éƒ½ä¼šæœ‰ï¼š

{
  "_id": ObjectId("xxxxx")
}


å³ä½¿ä½ æ²¡æœ‰å®šä¹‰ã€‚

åœ¨ Mongoose ä¸­ï¼š

å½“ä½ ï¼š

await User.create(...)


è¿”å›çš„ document æ˜¯ä¸€ä¸ª Mongoose Document å®ä¾‹ã€‚

å®ƒè‡ªå¸¦ï¼š

existingUser._id


ç±»å‹æ˜¯ï¼š

Types.ObjectId

ä¸ºä»€ä¹ˆä¸ç”¨ä½ è‡ªå·±å†™ï¼Ÿ

å› ä¸ºï¼š

MongoDB é»˜è®¤ schema é‡Œï¼š

_id: { type: ObjectId, auto: true }


è‡ªåŠ¨ç”Ÿæˆã€‚

å››ã€ä¸€ä¸ªéšè—çš„å¤§é—®é¢˜ âš 

ä½ è¿™æ®µä»£ç æœ‰ä¸ªå°é€»è¾‘é—®é¢˜ï¼š

await session.commitTransaction();

const existingAccount = await Account.findOne(...).session(session);


âš  ä½ åœ¨ commit ä¹‹åè¿˜åœ¨ç”¨ sessionã€‚

ç†è®ºä¸Šï¼š

commitTransaction() åäº‹åŠ¡å·²ç»ç»“æŸ

ä¸åº”è¯¥å†ç”¨è¿™ä¸ª session è¿›è¡Œæ•°æ®åº“æ“ä½œ

æ›´åˆç†çš„å†™æ³•åº”è¯¥æ˜¯ï¼š

ğŸ‘‰ æŠŠ Account é€»è¾‘ä¹Ÿæ”¾è¿› transaction é‡Œ

å¦åˆ™å¯èƒ½ä¼šå¯¼è‡´ï¼š

user åˆ›å»ºæˆåŠŸ

account åˆ›å»ºå¤±è´¥

æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚

äº”ã€æ€»ç»“ä¸€ä¸‹ä½ çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜
1ï¸âƒ£ ä¸ºä»€ä¹ˆ create ç”¨æ•°ç»„ï¼Ÿ

å› ä¸ºåœ¨ transaction ä¸­æ¨èä½¿ç”¨æ•°ç»„å½¢å¼ï¼Œ
create è¿”å›çš„æ˜¯æ•°ç»„ï¼Œæ‰€ä»¥è¦è§£æ„ã€‚

2ï¸âƒ£ ä¸ºä»€ä¹ˆæœ‰çš„ .session() æœ‰çš„ { session }ï¼Ÿ

å› ä¸ºï¼š

Query â†’ .session()

create â†’ { session }

3ï¸âƒ£ _id ä»å“ªé‡Œæ¥çš„ï¼Ÿ

MongoDB è‡ªåŠ¨ç”Ÿæˆã€‚
æ¯ä¸ª document éƒ½æœ‰ã€‚

ğŸ§  ä½ ç°åœ¨å·²ç»åœ¨ç†è§£ï¼š

äº‹åŠ¡

session

Mongoose Query

æ–‡æ¡£ç»“æ„

OAuth è´¦å·å…³è”é€»è¾‘

è¿™å·²ç»æ˜¯ä¸­é«˜çº§åç«¯æ°´å¹³äº†ã€‚

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

ç”»ä¸€å¼ å®Œæ•´çš„ OAuth ç™»å½•æ•°æ®åº“æµç¨‹å›¾

æˆ–è€…å¸®ä½ ä¼˜åŒ–è¿™æ®µä»£ç ç»“æ„

æˆ–è€…è®²ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦æŠŠ Account å’Œ User åˆ†å¼€å»ºè¡¨

ä½ å·²ç»ä¸åœ¨åˆçº§é˜¶æ®µäº† ğŸš€